#include <Arduino.h>
#include <Wire.h>
#include <Adafruit_MPR121.h>

#define IRQ_PIN 17  // Using GPIO17 for MPR121 IRQ

Adafruit_MPR121 cap = Adafruit_MPR121();
volatile bool touchInterrupt = false;

// map pad # â†’ output character
const char keymap[12] = {
  '*',  // pad 0 â†’ *
  '7',  // pad 1 â†’ 7
  '4',  // pad 2 â†’ 4
  '1',  // pad 3 â†’ 1
  '0',  // pad 4 â†’ 0
  '8',  // pad 5 â†’ 8
  '5',  // pad 6 â†’ 5
  '2',  // pad 7 â†’ 2
  '#',  // pad 8 â†’ #
  '9',  // pad 9 â†’ 9
  '6',  // pad 10 â†’ 6
  '3'   // pad 11 â†’ 3
};

// ISR for IRQ pin
void IRAM_ATTR handleTouchIRQ() {
  touchInterrupt = true;
}

void setup() {
  Serial.begin(115200);
  delay(2000);
  Serial.println("ğŸ”Œ MPR121 Touch Test with IRQ");

  // Initialize IRQ pin
  pinMode(IRQ_PIN, INPUT_PULLUP);
  attachInterrupt(digitalPinToInterrupt(IRQ_PIN), handleTouchIRQ, FALLING);

  // Initialize MPR121
  if (!cap.begin(0x5A)) {
    Serial.println("âŒ MPR121 not found. Check wiring!");
    while (1);
  }

  Serial.println("âœ… MPR121 ready (IRQ mode).");
}

void loop() {
  if (touchInterrupt) {
    touchInterrupt = false;  // Reset flag

    uint16_t touched = cap.touched();

    for (uint8_t i = 0; i < 12; i++) {
      if (touched & (1 << i)) {
        Serial.print("ğŸ”˜ Key ");
        Serial.print(i);
        Serial.print(" â†’ ");
        Serial.println(keymap[i]);
      }
    }
  }

  // Your heavy tasks here won't block touch detection
  // Example: delay(300); or any other long task
   for (int i = 0; i <= 1000; i++) {
    Serial.print("ğŸ”¢ Counter: ");
    Serial.println(i);
    delay(500);  // 500 ms delay between each step
    if (touchInterrupt){
    Serial.print("Touch detected");
    break;

         }

  }
  
}
