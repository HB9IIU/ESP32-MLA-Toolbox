<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Diagnostic Sweep Viewer</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Highcharts Core -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <style>
    body { padding-top: 60px; }
    .chart-container { margin-bottom: 40px; }
    .res-label { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
<!-- Top Navigation -->
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">MLA Tuner Diagnostic Page</a>
  </div>
</nav>

<main class="container">
  <!-- Coarse Sweep -->
  <div class="chart-container">
    <h4 id="coarseTitle">Coarse Sweep</h4>
    <div id="coarseChart"></div>
    <div class="res-label">Resonance Frequency: <span id="coarseFreq">â€“</span></div>
  </div>

  <!-- Fine Sweep -->
  <div class="chart-container">
    <h4 id="fineTitle">Fine Sweep</h4>
    <div id="fineChart"></div>
    <div class="res-label">Resonance Frequency: <span id="fineFreq">â€“</span></div>
  </div>
</main>

<script>
  let chartCoarse, chartFine;

  /**
   * Format a frequency in Hz with thousands separators.
   * Example: 12345678 -> "12.345.678 Hz"
   */
  function formatHz(freq) {
    return freq.toLocaleString('de-CH').replace(/,/g, '.') + ' Hz';
  }

  /**
   * Creates or updates both sweep charts with new data.
   */
  function updateCharts(data) {
    if (!data.coarse || !data.fine || !data.coarseMaxFreq || !data.fineMaxFreq) {
      console.warn("âš ï¸ Missing expected sweep data fields.");
      return;
    }

    const coarseData = data.coarse.map(p => [p[0], p[1]]);
    const fineData   = data.fine.map(p => [p[0], p[1]]);

    const coarsePeakHz = data.coarseMaxFreq;
    const finePeakHz   = data.fineMaxFreq;

    // Update frequency display
    document.getElementById('coarseFreq').innerText = formatHz(coarsePeakHz);
    document.getElementById('fineFreq').innerText   = formatHz(finePeakHz);

    // Update chart titles with point count
    document.getElementById('coarseTitle').innerText = `Coarse Sweep (${coarseData.length} points)`;
    document.getElementById('fineTitle').innerText   = `Fine Sweep (${fineData.length} points)`;

    // Coarse chart
    if (!chartCoarse) {
      chartCoarse = Highcharts.chart('coarseChart', {
        chart: { type: 'line' },
        title: { text: null },
        xAxis: {
          title: { text: 'Frequency (Hz)' },
          labels: {
            formatter: function () {
              return this.value.toLocaleString('de-CH').replace(/,/g, '.');
            }
          },
          plotLines: [{
            color: 'red',
            width: 2,
            dashStyle: 'Dash',
            value: coarsePeakHz
          }]
        },
        yAxis: { title: { text: 'ADC Value' } },
        series: [{
          name: 'ADC',
          data: coarseData
        }],
        credits: { enabled: false },
        accessibility: { enabled: false }
      });
    } else {
      chartCoarse.series[0].setData(coarseData);
      chartCoarse.xAxis[0].update({
        plotLines: [{
          color: 'red',
          width: 2,
          dashStyle: 'Dash',
          value: coarsePeakHz
        }]
      });
    }

    // Fine chart
    if (!chartFine) {
      chartFine = Highcharts.chart('fineChart', {
        chart: { type: 'line' },
        title: { text: null },
        xAxis: {
          title: { text: 'Frequency (Hz)' },
          labels: {
            formatter: function () {
              return this.value.toLocaleString('de-CH').replace(/,/g, '.');
            }
          },
          plotLines: [{
            color: 'green',
            width: 2,
            dashStyle: 'Dash',
            value: finePeakHz
          }]
        },
        yAxis: { title: { text: 'ADC Value' } },
        series: [
          {
            name: 'ADC (Raw)',
            data: fineData,
            type: 'line',
            marker: { enabled: false }
          },
          {
            name: 'ADC (Spline)',
            data: fineData,
            type: 'spline',
            color: 'orange',
            marker: { enabled: false },
            enableMouseTracking: false,
            linkedTo: ':previous'
          }
        ],
        credits: { enabled: false },
        accessibility: { enabled: false }
      });
    } else {
      chartFine.series[0].setData(fineData);
      chartFine.series[1].setData(fineData);
      chartFine.xAxis[0].update({
        plotLines: [{
          color: 'green',
          width: 2,
          dashStyle: 'Dash',
          value: finePeakHz
        }]
      });
    }
  }

  /**
   * Fetch sweep data from the ESP32 every 4 seconds.
   */
  async function fetchSweepData() {
    try {
      const response = await fetch('/sweepdata');
      const data = await response.json();

      console.log("ðŸ“¶ Sweep data received:", data);
      console.log(`ðŸ“¡ Coarse Peak: ${data.coarseMaxFreq.toLocaleString('de-CH')} Hz (ADC: ${data.coarseMaxADC})`);
      console.log(`ðŸŽ¯ Fine Peak:   ${data.fineMaxFreq.toLocaleString('de-CH')} Hz (ADC: ${data.fineMaxADC})`);

      updateCharts(data);
    } catch (error) {
      console.error("âŒ Error fetching sweep data:", error);
    }
  }

  // Initial fetch + refresh every 4s
  document.addEventListener('DOMContentLoaded', () => {
    fetchSweepData();
    setInterval(fetchSweepData, 4000);
  });
</script>
</body>
</html>
