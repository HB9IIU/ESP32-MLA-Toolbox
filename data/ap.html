<!DOCTYPE html>
<html class="h-100" lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta content="" name="description">
    <title>HB9IIU WSPR Beacon</title>
    <!-- Bootstrap core CSS -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="bootstrap/css/sticky-footer-navbar.css" rel="stylesheet">
    <style>
        /* Custom CSS for styling the frame */
        .custom-frame {
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            padding: .375rem .75rem;
            font-size: 1.5rem;
            width: fit-content;
            max-width: 200px;
            margin: auto;
        }

        /* Fixed width for the number display */
        #numberDisplay {
            min-width: 80px;
            text-align: center;
            display: inline-block;
            background-color: #cc7722;
            color: white;
            padding: 5px;
            border-radius: 5px;
        }

        /* Style for the button group */
        .button-group {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Center the save button */
        .save-button {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        /* Spinner styles */
        .spinner-border {
            width: 3rem;
            height: 3rem;
            margin-top: 20px;
        }
    </style>
</head>
<body class="d-flex flex-column h-100" onload="initializePage()">
<header>
    <!-- Fixed navbar -->
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <div class="container-fluid"><a class="navbar-brand" href="#">Web WSPR Beacon</a>
            <button aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation"
                    class="navbar-toggler" data-bs-target="#navbarCollapse" data-bs-toggle="collapse" type="button"><span
                    class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>
</header>
<!-- Begin page content -->
<main class="flex-shrink-0">
    <div class="container">
        <div class="row">
            <h4>Select Your WiFi Network and Enter the Password</h4>
        </div>
        <h5 class="mt-3">Password</h5>
        <div class="input-group">
            <input type="password" id="password" class="form-control" placeholder="Enter your WiFi password">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" id="togglePassword">Show</button>
            </div>
        </div>
        <h5 class="mt-3">Available Networks (SSID)</h5>
        <div id="loadingSpinner" class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Scanning for networks...</p>
        </div>
        <form id="networkForm" style="display:none;">
            <ul id="networkList" class="list-group"></ul>
            <div class="save-button">
                <button type="button" class="btn btn-primary" onclick="saveSelectedSSID()">Save</button>
            </div>
        </form>
        <!-- Alert messages -->
        <div id="alertMessage1" class="alert alert-info mt-3" role="alert" style="display:none;"></div>
        <div id="alertMessage2" class="alert alert-info mt-3" role="alert" style="display:none;"></div>
    </div>
</main>
<footer class="footer mt-auto py-3 bg-light">
    <div class="container"><span class="text-muted">HB9IIU May 2024</span>
    </div>
</footer>
<script>
    function initializePage() {
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('networkForm').style.display = 'none';

        fetch('/scanNetworks')
            .then(response => response.json())
            .then(data => {
                const networkList = document.getElementById('networkList');
                data.networks.forEach((network, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `<input type="radio" name="network" id="network${index}" value="${network.ssid}">
                                        <label for="network${index}">${network.ssid} (${network.rssi} dBm) - ${network.encryptionType}</label>`;
                    networkList.appendChild(li);
                });

                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('networkForm').style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching network list:', error);
                document.getElementById('loadingSpinner').innerHTML = '<p class="text-danger">Error fetching network list. Please try again later.</p>';
            });
    }

    function saveSelectedSSID() {
        const selectedNetwork = document.querySelector('input[name="network"]:checked');
        const password = document.getElementById('password').value.trim();
        if (selectedNetwork && password) {
            const ssid = selectedNetwork.value;
            fetch(`/saveSelectedSSID?ssid=${encodeURIComponent(ssid)}&password=${encodeURIComponent(password)}`)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('alertMessage1').innerHTML = 'WSPR server will now reboot and should normally be accessible via <a href="http://esp32_wspr.local">http://esp32_wspr.local</a>. If not, please scan your network with a tool like Angry Scanner to find the IP address.';
                    document.getElementById('alertMessage1').style.display = 'block';

                    setTimeout(() => {
                        document.getElementById('alertMessage2').innerHTML = 'Redirecting to <a href="http://esp32_wspr.local">http://esp32_wspr.local</a>...';
                        document.getElementById('alertMessage2').style.display = 'block';

                        setTimeout(() => {
                            window.location.href = 'http://esp32_wspr.local';
                        }, 2000);
                    }, 5000);
                })
                .catch(error => {
                    console.error('Error saving SSID and Password:', error);
                });
        } else {
            alert('Please select a network and enter a password.');
        }
    }

    document.getElementById('togglePassword').addEventListener('click', function () {
        const passwordField = document.getElementById('password');
        const toggleButton = document.getElementById('togglePassword');

        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            toggleButton.textContent = 'Hide';
        } else {
            passwordField.type = 'password';
            toggleButton.textContent = 'Show';
        }
    });
</script>
</body>
</html>
