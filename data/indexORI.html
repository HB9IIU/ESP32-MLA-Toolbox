<!DOCTYPE html>
<html class="h-100" lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta content="" name="description">
    <title>HB9IIU WSPR Beacon</title>
    <!-- Bootstrap core CSS -->
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Include Leaflet CSS -->
    <link crossorigin="" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet">
    <!-- Include Leaflet Marker Cluster CSS -->
    <link href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" rel="stylesheet"/>
    <link href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" rel="stylesheet"/>
    <!-- Include Cesium CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.92.0/Widgets/widgets.css" rel="stylesheet">
    <style>
       
       main > .container {
    padding: 60px 15px 0;
    margin-top: 15px;
}

       
        /* Force uppercase input */
        #callsign, #locator { text-transform: uppercase; }
        /* Limit width for power field */
        #power { width: 100px; }
        /* Center text in input fields */
        input[type="text"] { text-align: center; }
        /* Center reboot button */
        .reboot-button { display: flex; justify-content: center; }
        /* Increase height of progress bars */
        .progress { height: 30px; }
        /* Hide progress bar container by default */
        .progress-container { display: none; }
        /* Keyframes for the blinking animation */
        @keyframes blink { 0% {  background-color: red; }  50% {  background-color: transparent; }  100% {  background-color: red; } }
        /* Highlight selected band with blinking red background and white text */
        .highlight_TX { animation: blink 1s infinite; color: white; }
        /* Highlight selected band with blinking red background and white text */
        .highlight_RX { background-color: grey; color: white; }
        /* Align distance column values to the right */
        .text-end { text-align: right; }
        /* Center text */
        .text-center { text-align: center; }
        #overlay { position: fixed; display: none; width: 100%; height: 100%; top: 0; left: 0; background-color: rgba(0, 0, 0, 0.7);  /* Darker background for better visibility */ z-index: 9999;  /* Ensure it's on top of all other elements */ cursor: pointer; }
        #overlay-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white; font-size: 20px; }
        .spinner { border: 16px solid #f3f3f3;  /* Light grey */ border-top: 16px solid #3498db;  /* Blue */ border-radius: 50%; width: 120px; height: 120px; animation: spin 2s linear infinite; margin: 0 auto 20px;  /* Center the spinner and add some space below */ }
        @keyframes spin { 0% {  transform: rotate(0deg); }  100% {  transform: rotate(360deg); } }
        #map { width: 100%; height: 600px; margin-bottom: 20px; }
        #cesiumContainer { width: 100%; height: 600px; margin-bottom: 20px; }
        /* Loading spinner */
        #loadingSpinner { display: none; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
        .custom-button { max-width: 300px;  /* Adjust this value as needed */ width: 100%; font-size: 18px;  /* Adjust font size as needed */ }
        .modal-logo { width: 160px; height: 160px; }
    </style>
</head>
<body class="d-flex flex-column h-100">
<header>
    <!-- Fixed navbar -->
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <div class="container-fluid"><a class="navbar-brand" href="#">Web WSPR Beacon</a>
            <button aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#navbarCollapse" data-bs-toggle="collapse" type="button">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav me-auto mb-2 mb-md-0">
                    <li class="nav-item "><a id="calibration_link" class="active nav-link" href="calibrate.html" target="_blank">Calibration</a>
                    </li>
                    <li class="nav-item"><a class="active nav-link" href="https://wspr.rocks/" target="_blank">wspr.rocks</a>
                    </li>
                </ul>
            </div>
            <h6 id="version" style="color: #7f7f7f;">Beta 1.0</h6>
        </div>
    </nav>
</header>
<!-- Begin page content -->
<main class="flex-shrink-0">
    <div class="container">
        <div class="row">
            <div class="col-6 col-lg-4 col-md-4 col-sm-6 col-xl-4 col-xxl-4">
                <h4>Band Selection</h4>
                <div class="row">
                    <div class="mb-3 form-check col-12">
                        <input class="form-check-input" id="checkbox1" onchange="sendCheckboxState('checkbox1')" type="checkbox">
                        <label class="form-check-label" data-frequency="28126100" for="checkbox1"><strong>10m</strong>
                            28.126,100 MHz
                        </label>
                    </div>
                    <div class="mb-3 form-check col-12">
                        <input class="form-check-input" id="checkbox2" onchange="sendCheckboxState('checkbox2')" type="checkbox">
                        <label class="form-check-label" data-frequency="24926100" for="checkbox2"><strong>12m</strong>
                            24.926,100 MHz
                        </label>
                    </div>
                    <div class="mb-3 form-check col-12">
                        <input class="form-check-input" id="checkbox3" onchange="sendCheckboxState('checkbox3')" type="checkbox">
                        <label class="form-check-label" data-frequency="21096100" for="checkbox3"><strong>15m</strong>
                            21.096,100 MHz
                        </label>
                    </div>
                    <div class="mb-3 form-check col-12">
                        <input class="form-check-input" id="checkbox4" onchange="sendCheckboxState('checkbox4')" type="checkbox">
                        <label class="form-check-label" data-frequency="18106100" for="checkbox4"><strong>17m</strong>
                            18.106,100 MHz
                        </label>
                    </div>
                    <div class="mb-3 form-check col-12">
                        <input class="form-check-input" id="checkbox5" onchange="sendCheckboxState('checkbox5')" type="checkbox">
                        <label class="form-check-label" data-frequency="14097100" for="checkbox5"><strong>20m</strong>
                            14.097,100 MHz
                        </label>
                    </div>
                    <div class="mb-3 form-check col-12">
                        <input class="form-check-input" id="checkbox6" onchange="sendCheckboxState('checkbox6')" type="checkbox">
                        <label class="form-check-label" data-frequency="10140200" for="checkbox6"><strong>30m</strong>
                            10.140,200 MHz
                        </label>
                    </div>
                    <div class="mb-3 form-check col-12">
                        <input class="form-check-input" id="checkbox7" onchange="sendCheckboxState('checkbox7')" type="checkbox">
                        <label class="form-check-label" data-frequency="7040100" for="checkbox7"><strong>40m</strong>
                            7.040,100 MHz
                        </label>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-4 col-md-4 col-sm-6 col-xl-4 col-xxl-4">
                <h4>TX Schedule</h4>
                <div class="row">
                    <div class="mb-3 form-check col-12">
                        <input class="form-check-input" id="schedule1" name="txInterval" onchange="sendScheduleState('schedule1')" type="radio">
                        <label class="form-check-label" for="schedule1">TX every 2 minutes</label>
                    </div>
                    <div class="mb-3 form-check col-12">
                        <input class="form-check-input" id="schedule2" name="txInterval" onchange="sendScheduleState('schedule2')" type="radio">
                        <label class="form-check-label" for="schedule2">TX every 4 minutes</label>
                    </div>
                    <div class="mb-3 form-check col-12">
                        <input class="form-check-input" id="schedule3" name="txInterval" onchange="sendScheduleState('schedule3')" type="radio">
                        <label class="form-check-label" for="schedule3">TX every 6 minutes</label>
                    </div>
                    <div class="mb-3 form-check col-12">
                        <input class="form-check-input" id="schedule4" name="txInterval" onchange="sendScheduleState('schedule4')" type="radio">
                        <label class="form-check-label" for="schedule4">TX every 8 minutes</label>
                    </div>
                    <div class="mb-3 form-check col-12">
                        <input class="form-check-input" id="schedule5" name="txInterval" onchange="sendScheduleState('schedule5')" type="radio">
                        <label class="form-check-label" for="schedule5">TX every 10 minutes</label>
                    </div>
                </div>
                <h3 class="text-center" id="clock" style="margin-top: 25px;">00:00:00</h3>
            </div>
            <div class="col-12 col-lg-4 col-md-4 col-sm-12 col-xl-4 col-xxl-4">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Callsign</h4>
                        <div class="mb-3">
                            <input class="form-control" id="callsign" maxlength="6" oninput="validateCallsign()" type="text">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4>Locator</h4>
                        <div class="mb-3">
                            <input class="form-control" id="locator" maxlength="6" oninput="validateLocator()" type="text">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h4 style="text-align: center;">&nbsp;Power (mW)</h4>
                        <div class="mb-3 d-flex justify-content-center">
                            <input class="form-control custom-input" id="power" maxlength="5" oninput="validatePower()" type="text">
                        </div>
                        <p id="powerdbm" style="text-align: center; margin-top: 5px; font-style: italic; font-size: 12px;">..dBm</p>
                    </div>
                    <div class="col-md-6">
                        <img src="assets/logo.png" width="100%">
                    </div>
                </div>
                <div class="container mt-auto">
                    <div class="row justify-content-center">
                        <div class="col-12 col-md-auto d-flex flex-column align-items-center">
                            <button class="btn btn-success custom-button mb-2" onclick="rebootESP32()" type="button">
                                Reboot
                            </button>
                            <button class="btn btn-danger custom-button" onclick="factoryReset()" type="button">Factory Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <h4 id="progressText">Waiting for next transmission slot</h4>
        </div>
        <div class="row progress-container" id="greenProgressContainer">
            <div class="g-0 progress mx-auto">
                <div aria-valuemax="120" aria-valuemin="0" aria-valuenow="0" class="progress-bar bg-success progress-bar-striped" id="progressBar" role="progressbar" style="width: 0%;"><span id="progressLabel"></span>
                </div>
            </div>
        </div>
        <div class="row progress-container" id="redProgressContainer">
            <div class="g-0 progress mx-auto">
                <div aria-valuemax="120" aria-valuemin="0" aria-valuenow="0" class="progress-bar bg-danger progress-bar-striped" id="TXprogressBAR" role="progressbar" style="width: 0%;"><span id="TXProgressLabel"></span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="container d-flex justify-content-center">
                <div id="map" style="margin-top: 15px;"></div>
            </div>
        </div>
        <div class="row">
            <div class="container d-flex justify-content-center">
                <div id="cesiumContainer"></div>
            </div>
        </div>
        <div id="alertPlaceholder"></div>
        <div class="row">
            <div aria-label="Basic example" class="btn-group" role="group">
                <button class="btn btn-secondary" onclick="filterByBand(7)" type="button">40 m</button>
                <button class="btn btn-secondary" onclick="filterByBand(10)" type="button">30 m</button>
                <button class="btn btn-secondary" onclick="filterByBand(14)" type="button">20 m</button>
                <button class="btn btn-secondary" onclick="filterByBand(21)" type="button">15 m</button>
                <button class="btn btn-secondary" onclick="filterByBand(24)" type="button">12 m</button>
                <button class="btn btn-secondary" onclick="filterByBand(28)" type="button">10 m</button>
            </div>
            <div class="container mt-5">
                <div id="results"></div>
            </div>
        </div>
        <div class="d-flex justify-content-center mt-5" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</main>
<footer class="footer mt-auto py-3 bg-light">
    <div class="container">
        <span class="text-muted">HB9IIU May 2025</span>
    </div>
</footer>
<!-- Overlay -->
<div id="overlay">
    <div id="overlay-content">
        <div class="spinner"></div>
        <div>Please wait, rebooting...</div>
    </div>
</div>
<!-- Factory Reset Modal -->
<div aria-hidden="true" aria-labelledby="factoryResetModalLabel" class="modal fade" id="factoryResetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header d-flex flex-column align-items-center">
                <h5 class="modal-title" id="factoryResetModalLabel">Factory Reset Confirmation</h5>
                <img alt="Logo" class="modal-logo mt-2" src="assets/logo.png">
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                By clicking Yes, the ESP32 will be reset to factory default settings, meaning that all configurations
                will be lost. A reconfiguration via AP (network: HB9IIU-WSPR-CONFIG, IP: 192.168.4.1) will be required.
                Do you want to proceed?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
                <button class="btn btn-primary" id="confirmFactoryReset" type="button">Yes</button>
            </div>
        </div>
    </div>
</div>
<!-- Include Bootstrap Bundle JS -->
<script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Include Leaflet JS -->
<script crossorigin="" src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<!-- Include Leaflet-Geodesic JS -->
<script src="https://cdn.jsdelivr.net/npm/leaflet.geodesic"></script>
<!-- Include Leaflet Marker Cluster JS -->
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<!-- Include Cesium JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.92.0/Cesium.js"></script>
<script>
    let txSign = 'NOCALL'; // Default value
    let map; // Global variable to store the map instance
    let viewer; // Global variable to store the Cesium viewer instance

    document.addEventListener('DOMContentLoaded', function () {
        // Hide the overlay when the page is loaded
        document.getElementById('overlay').style.display = 'none';

        // Initialize the Cesium viewer
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJhNDZlN2ZjNi0wMzUxLTQ1OTUtOTNiMS0xM2QyYjg3ZDc0NzUiLCJpZCI6MjI5ODU5LCJpYXQiOjE3MjE2MzIyODJ9.haU4k5KGFfik36d9-nwFrGLZDP7KpYAwJGtVlS4ICoA';
        viewer = new Cesium.Viewer('cesiumContainer', {
            imageryProvider: Cesium.createWorldImagery(),
            baseLayerPicker: false,
            timeline: false,
            animation: false,
            geocoder: false // Disable the geocoder widget
        });

        // Ensure the globe displays the entire world
        viewer.scene.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(0, 0, 20000000) // Adjust the height as needed
        });

        // Fetch the saved version from the ESP32 server
        fetch('/getVersion')
            .then(response => response.json())
            .then(data => {
                console.log("Fetched version data: ", data);  // Log the fetched data
                if (data.version) {
                    console.log("Fetched version:", data.version);
                    document.getElementById('version').textContent = data.version;
                }
            })
            .catch(error => console.error('Error fetching version:', error));

        // Fetch the saved checkbox states from the ESP32
        fetch('/getCheckboxStates')
            .then(response => response.json())
            .then(data => {
                for (const [id, state] of Object.entries(data)) {
                    document.getElementById(id).checked = state;
                }
            })
            .catch(error => console.error('Error fetching checkbox states:', error));

        // Fetch the saved schedule button state from the ESP32
        fetch('/getScheduleState')
            .then(response => response.json())
            .then(data => {
                if (data.scheduleState) {
                    document.getElementById(data.scheduleState).checked = true;
                }
            })
            .catch(error => console.error('Error fetching schedule state:', error));

        // Fetch the saved callsign from the ESP32 and then call fetchData
        fetch('/getCallsign')
            .then(response => response.json())
            .then(data => {
                if (data.callsign) {
                    document.getElementById('callsign').value = data.callsign;
                    txSign = data.callsign.toUpperCase();
                    console.log("Fetched callsign and set txSign:", txSign);
                }
            })
            .catch(error => console.error('Error fetching callsign:', error))
            .then(() => {
                // After setting txSign, fetch the locator, power, and data
                return Promise.all([
                    fetch('/getLocator')
                        .then(response => response.json())
                        .then(data => {
                            if (data.locator) {
                                document.getElementById('locator').value = data.locator;
                            }
                        })
                        .catch(error => console.error('Error fetching locator:', error)),
                    fetch('/getPower')
                        .then(response => response.json())
                        .then(data => {
                            if (data.power) {
                                document.getElementById('power').value = data.power;
                                updatePowerDBM(data.power); // Update power in dBm
                            }
                        })
                        .catch(error => console.error('Error fetching power:', error)),

                ]);
            })
            .then(() => {
                // Set interval to update time every second (1000 milliseconds)
                setInterval(displayTime, 1000);

                // Update the progress bar every second
                setInterval(updateProgressBar, 1000);

                // Fetch data and plot the map and globe when the page loads
                fetchData().then(data => {
                    displayData(data);
                    plotMap(data);
                    plotGlobe(data);
                }).catch(error => {
                    displayError(error);
                });
            });
    });

    function validatePower() {
        var power = document.getElementById('power').value;
        var validPower = power.replace(/[^0-9]/g, ''); // Remove non-numeric characters

        document.getElementById('power').value = validPower;
        sendPower();

        // Convert to dBm and update powerdbm field
        updatePowerDBM(validPower);
    }

    function updatePowerDBM(mW) {
        if (mW === "") {
            document.getElementById('powerdbm').value = "";
        } else {
            var dBm = 10 * Math.log10(mW);

            document.getElementById('powerdbm').textContent = dBm.toFixed(1) + " dBm";
        }
    }

    function sendPower() {
        var power = document.getElementById('power').value;

        // Send an HTTP request to your ESP32 server with the power
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/updatePower?power=' + power, true);
        xhr.send();
    }

    function highlightBandSelection_while_waiting(frequency) {
        var labels = document.querySelectorAll('.form-check-label');
        var filteredLabels = Array.from(labels).filter(function (label) {
            return !label.closest('.col-md-4:nth-child(2)');
        });

        filteredLabels.forEach(label => {
            var labelFrequency = label.getAttribute('data-frequency');
            if (labelFrequency && parseInt(labelFrequency) === frequency) {
                label.classList.add('highlight_RX');
            } else {
                label.classList.remove('highlight_RX');
                label.classList.remove('highlight_TX');
            }
        });
    }

    function highlightBandSelection_while_transmitting(frequency) {
        var labels = document.querySelectorAll('.form-check-label');
        var filteredLabels = Array.from(labels).filter(function (label) {
            return !label.closest('.col-md-4:nth-child(2)');
        });

        filteredLabels.forEach(label => {
            var labelFrequency = label.getAttribute('data-frequency');
            if (labelFrequency && parseInt(labelFrequency) === frequency) {
                label.classList.add('highlight_TX');
            } else {
                label.classList.remove('highlight_TX');
                label.classList.remove('highlight_RX');
            }
        });
    }

    function updateProgressBar() {
        fetch('/getTimes')
            .then(response => response.json())
            .then(data => {
                var remainingTime = data.currentRemainingSeconds;
                var txRunningTime = data.txRunningTime;
                var TX_referenceFrequ = data.TX_referenceFrequ;
                var calibrateMenuItem = document.getElementById("calibration_link");

                // Update the green progress bar
                var progressBar = document.getElementById('progressBar');
                var progressLabel = document.getElementById('progressLabel');
                var greenProgressContainer = document.getElementById('greenProgressContainer');
                var transmittingText = document.getElementById('progressText');
                if (remainingTime > 0) {
                    var percentage = Math.floor((remainingTime / 120) * 100);
                    greenProgressContainer.style.display = 'block'; // Show the container
                    progressBar.style.width = percentage + '%';
                    progressBar.setAttribute('aria-valuenow', remainingTime);
                    progressLabel.textContent = remainingTime + 's'; // Update the label with remaining time
                    transmittingText.textContent = 'Waiting for next transmission slot';
                    highlightBandSelection_while_waiting(TX_referenceFrequ);

                    // Enable the "Calibrate" menu item when the green progress bar is visible
                    if (calibrateMenuItem) {
                        calibrateMenuItem.classList.remove('disabled');
                        calibrateMenuItem.classList.add('active');
                    }
                } else {
                    greenProgressContainer.style.display = 'none'; // Hide the container
                }

                // Update the red progress bar
                var TXprogressBAR = document.getElementById('TXprogressBAR');
                var TXProgressLabel = document.getElementById('TXProgressLabel');
                var redProgressContainer = document.getElementById('redProgressContainer');
                if (txRunningTime > 0) {
                    var TXPercentage = Math.floor((txRunningTime / 120) * 100);
                    redProgressContainer.style.display = 'block'; // Show the container
                    TXprogressBAR.style.width = TXPercentage + '%';
                    TXprogressBAR.setAttribute('aria-valuenow', txRunningTime);
                    TXProgressLabel.textContent = txRunningTime + 's'; // Update the label with auto progress time
                    transmittingText.textContent = 'Transmitting';
                    highlightBandSelection_while_transmitting(TX_referenceFrequ);

                    // Disable the "Calibrate" menu item when the red progress bar is visible
                    if (calibrateMenuItem) {
                        calibrateMenuItem.classList.remove('active');
                        calibrateMenuItem.classList.add('disabled');
                    }
                } else {
                    redProgressContainer.style.display = 'none'; // Hide the container
                }
            })
            .catch(error => console.error('Error fetching times:', error));
    }

    function validateCallsign() {
        var callsign = document.getElementById('callsign').value.toUpperCase();
        var validCallsign = "";

        for (var i = 0; i < callsign.length; i++) {
            var char = callsign.charAt(i);

            if (i === 0) {
                // 1st character: can be a letter, number, or left blank
                if (char.match(/[A-Z0-9]/) || char === "") {
                    validCallsign += char;
                }
            } else if (i === 1) {
                // 2nd character: can be a letter or number
                if (char.match(/[A-Z0-9]/)) {
                    validCallsign += char;
                }
            } else if (i === 2) {
                // 3rd character: can only be a number
                if (char.match(/[0-9]/)) {
                    validCallsign += char;
                }
            } else if (i >= 3 && i <= 5) {
                // 4th, 5th, and 6th characters: can only be a letter or left blank
                if (char.match(/[A-Z]/) || char === "") {
                    validCallsign += char;
                }
            }
        }

        document.getElementById('callsign').value = validCallsign;
        txSign = validCallsign;
        console.log('TX Sign updated to:', txSign);
        sendCallsign();
    }

    function sendCallsign() {
        var callsign = document.getElementById('callsign').value;

        // Send an HTTP request to your ESP32 server with the callsign
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/updateCallsign?callsign=' + callsign, true);
        xhr.send();
    }




    function sendCheckboxState(checkboxId) {
        var checkbox = document.getElementById(checkboxId);
        var state = checkbox.checked ? '1' : '0';

        // Send an HTTP request to your ESP32 server with the checkbox state
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/updateCheckboxState?id=' + checkboxId + '&state=' + state, true);
        xhr.send();
    }

    function sendScheduleState(scheduleId) {
        // Send an HTTP request to your ESP32 server with the schedule button state
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/updateScheduleState?id=' + scheduleId, true);
        xhr.send();
    }

    function validateLocator() {
        var locator = document.getElementById('locator').value.toUpperCase();
        var validLocator = "";

        for (var i = 0; i < locator.length; i++) {
            var char = locator.charAt(i);

            if (i === 0 || i === 1) {
                // 1st and 2nd characters: must be a letter A-R
                if (char.match(/[A-R]/)) {
                    validLocator += char;
                }
            } else if (i === 2 || i === 3) {
                // 3rd and 4th characters: must be a digit 0-9
                if (char.match(/[0-9]/)) {
                    validLocator += char;
                }
            } else if (i === 4 || i === 5) {
                // 5th and 6th characters: must be a letter A-X, convert to lowercase
                if (char.match(/[A-X]/)) {
                    validLocator += char.toLowerCase();
                }
            }
        }

        document.getElementById('locator').value = validLocator;
        sendLocator();
    }

    function sendLocator() {
        var locator = document.getElementById('locator').value;

        // Send an HTTP request to your ESP32 server with the locator
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/updateLocator?locator=' + locator, true);
        xhr.send();
    }

    function fetchData() {
        console.log("txSign:", txSign);
        const hoursToSubtract = 2; // You can set this variable dynamically as needed
        const limit = 2000;
        const query = `
        SELECT * FROM wspr.rx
        WHERE time > subtractHours(now(), ${hoursToSubtract})
        AND tx_sign = '${txSign}'
        ORDER BY time DESC
        LIMIT ${limit} FORMAT JSON
    `;
        const url = `https://db1.wspr.live:443/?query=${encodeURIComponent(query)}`;

        console.log('Fetching data from URL:', url);

        document.getElementById('loadingSpinner').style.display = 'block';

        return fetch(url, {
            method: 'GET'
        })
            .then(response => {
                console.log('Response status:', response.status);

                if (response.ok) {
                    return response.text().then(textData => {
                        return JSON.parse(textData);
                    });
                } else {
                    return response.text().then(errorText => {
                        console.error('Error response text:', errorText);
                        throw new Error('Error fetching data: ' + errorText);
                    });
                }
            })
            .then(data => {
                console.log('Parsed JSON data:', data);
                return data;
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                throw new Error('Error fetching data: ' + error.message);
            })
            .finally(() => {
                document.getElementById('loadingSpinner').style.display = 'none';
            });
    }

    function rebootESP32() {
        console.log('Reboot button clicked');
        // Show the overlay
        const overlay = document.getElementById('overlay');
        if (overlay) {
            overlay.style.display = 'block';
            console.log('Overlay displayed');
        } else {
            console.log('Overlay not found');
        }

        // Send an HTTP request to your ESP32 server to reboot
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/reboot', true);
        xhr.send();

        // Wait for the page to become available again
        setTimeout(checkPageAvailability, 5000); // Start checking after a delay
    }

    function factoryReset() {
        console.log('Factory Reset button clicked');
        // Show the modal
        var factoryResetModal = new bootstrap.Modal(document.getElementById('factoryResetModal'));
        factoryResetModal.show();

        // Handle the confirmation button click
        document.getElementById('confirmFactoryReset').addEventListener('click', function () {
            console.log('Factory Reset confirmed');
            // Send an HTTP request to your ESP32 server to factory reset
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/factoryReset', true);
            xhr.send();

            // Hide the modal
            factoryResetModal.hide();
        });
    }

    function checkPageAvailability() {
        fetch('/getCheckboxStates')
            .then(response => {
                if (response.ok) {
                    // Hide the overlay once the page is available again
                    document.getElementById('overlay').style.display = 'none';
                    location.reload();
                } else {
                    // Retry after a short delay if the page is not yet available
                    setTimeout(checkPageAvailability, 2000);
                }
            })
            .catch(error => {
                // Retry after a short delay if there was an error (e.g., network error)
                setTimeout(checkPageAvailability, 2000);
            });
    }

    function displayTime() {
        // Get current date/time
        let now = new Date();

        // Extract hours, minutes, and seconds
        let hours = now.getHours();
        let minutes = now.getMinutes();
        let seconds = now.getSeconds();

        // Format hours, minutes, and seconds to ensure two digits
        if (hours < 10) {
            hours = '0' + hours;
        }
        if (minutes < 10) {
            minutes = '0' + minutes;
        }
        if (seconds < 10) {
            seconds = '0' + seconds;
        }

        // Construct the time string in 24-hour format
        let time24 = hours + ':' + minutes + ':' + seconds;

        // Display the time
        let clockElement = document.getElementById('clock');
        if (clockElement) {
            clockElement.textContent = time24;
        }
    }

    const headers = ['time', 'since', 'band', 'rx_sign', 'rx_loc', 'distance', 'snr', 'version'];
    let sortOrder = {}; // Object to keep track of sorting order for each column

    const bandMapping = {
        7: '40 m',
        10: '30 m',
        14: '20 m',
        21: '15 m',
        24: '12 m',
        28: '10 m'
    };

    // Define colors for each band
    const bandColors = {
        7: '#FF0000',  // Red for 40 m
        10: '#00FF00', // Green for 30 m
        14: '#0000FF', // Blue for 20 m
        21: '#FFFF00', // Yellow for 15 m
        24: '#FF00FF', // Magenta for 12 m
        28: '#00FFFF'  // Cyan for 10 m
    };

    async function filterByBand(band) {
        try {
            console.log(`Filtering by band: ${bandMapping[band]}`);
            const data = await fetchData();
            console.log('Received data:', data);
            const filteredData = data.data.filter(row => row.band === band);
            console.log('Filtered data:', filteredData);
            if (filteredData.length === 0) {
                showNoRecordsAlert();
            } else {
                displayData({data: filteredData});
                plotMap({data: filteredData});
                plotGlobe({data: filteredData});
            }
        } catch (error) {
            displayError(error);
        }
    }

    function displayData(data) {
        const resultsDiv = document.getElementById('results');
        const rows = data.data;

        if (rows.length === 0) {
            resultsDiv.innerHTML = '<div class="alert alert-info" role="alert">No data available.</div>';
            return;
        }

        const displayHeaders = ['UTC Time', 'Since', 'Band', 'RX Call', 'RX Loc', 'Distance', 'SNR', 'Version'];

        let table = '<table class="table table-striped table-bordered"><thead class="table-dark"><tr>';
        displayHeaders.forEach((header, index) => {
            table += `<th onclick="sortTable(${index})">${header}</th>`;
            sortOrder[index] = 'asc';
        });
        table += '</tr></thead><tbody>';

        rows.forEach(row => {
            const since = calculateSince(row.time);
            table += '<tr>';
            headers.forEach(header => {
                const isCenterAligned = ['band', 'rx_sign', 'rx_loc', 'snr'].includes(header);
                table += `<td class="${header === 'distance' ? 'text-end' : ''} ${isCenterAligned ? 'text-center' : ''}">${header === 'since' ? since : row[header]}</td>`;
            });
            table += '</tr>';
        });

        table += '</tbody></table>';
        resultsDiv.innerHTML = table;
    }

    function calculateSince(time) {
        const now = new Date();
        const timeDate = new Date(time.replace(" ", "T") + "Z");
        const diffMs = now - timeDate;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 60) {
            return `${diffMins} minute(s) ago`;
        } else {
            const diffHours = Math.floor(diffMins / 60);
            const remainingMins = diffMins % 60;
            return `${diffHours} hour(s) ${remainingMins} minute(s) ago`;
        }
    }

    function displayError(error) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="alert alert-danger" role="alert">' + error + '</div>';
    }

    function plotMap(data) {
        if (map) {
            map.remove();
        }

        map = L.map('map', {zoomControl: false}).setView([46.8182, 8.2275], 2);

        var layers = {
            "Street View": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Map data © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }),
            "Satellite View": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles © Esri'
            })
        };

        layers["Street View"].addTo(map);
        L.control.layers(layers).addTo(map);

        var markers = L.markerClusterGroup();
        var allLatLngs = [];

        var reducedBlueIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
            iconSize: [15, 25],
            iconAnchor: [7.5, 25],
            popupAnchor: [0, -25]
        });

        var homeLocation;

        data.data.forEach(function (row) {
            if (!homeLocation) {
                homeLocation = new L.LatLng(row.tx_lat, row.tx_lon);
            }

            var rxCoords = new L.LatLng(row.rx_lat, row.rx_lon);
            var rxMarker = L.marker(rxCoords, {
                draggable: false,
                icon: reducedBlueIcon
            }).bindPopup('<a href="https://www.qrz.com/db/' + row.rx_sign + '" target="_blank">' + row.rx_sign + '</a><br>' + row.distance + ' km');
            markers.addLayer(rxMarker);

            // Determine the color based on the band
            var lineColor = bandColors[row.band] || '#000000'; // Default to black if band color not defined

            L.geodesic([homeLocation, rxCoords], {
                weight: 1,
                opacity: 1,
                color: lineColor,
                wrap: false,
                steps: 4
            }).addTo(map);
            allLatLngs.push(rxCoords);
        });

        // Add home location to allLatLngs if it's defined
        if (homeLocation) {
            allLatLngs.push(homeLocation);
        }

        if (allLatLngs.length === 0) {
            showNoRecordsAlert();
        } else {
            map.addLayer(markers);
            var bounds = L.latLngBounds(allLatLngs);
            map.fitBounds(bounds);
        }

        // Add legend to the map
        var legend = L.control({position: 'bottomright'});

        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML = '<strong>Band Colors</strong><br>';
            for (var band in bandMapping) {
                if (bandMapping.hasOwnProperty(band)) {
                    div.innerHTML += '<i style="background:' + bandColors[band] + '"></i> ' + bandMapping[band] + '<br>';
                }
            }
            return div;
        };

        legend.addTo(map);
    }

    function plotGlobe(data) {
        viewer.entities.removeAll();

        var homeLocation;
        var bandColors = {
            7: Cesium.Color.RED,  // Red for 40 m
            10: Cesium.Color.GREEN, // Green for 30 m
            14: Cesium.Color.BLUE, // Blue for 20 m
            21: Cesium.Color.YELLOW, // Yellow for 15 m
            24: Cesium.Color.MAGENTA, // Magenta for 12 m
            28: Cesium.Color.CYAN  // Cyan for 10 m
        };

        data.data.forEach(function (row) {
            if (!homeLocation) {
                homeLocation = Cesium.Cartesian3.fromDegrees(row.tx_lon, row.tx_lat);
            }

            var rxLocation = Cesium.Cartesian3.fromDegrees(row.rx_lon, row.rx_lat);
            var lineColor = bandColors[row.band] || Cesium.Color.BLACK; // Default to black if band color not defined

            viewer.entities.add({
                polyline: {
                    positions: [homeLocation, rxLocation],
                    width: 1,
                    material: lineColor
                }
            });
        });

        if (homeLocation) {
            viewer.zoomTo(viewer.entities);
        }
    }

    function sortTable(columnIndex) {
        const table = document.querySelector('table tbody');
        const rows = Array.from(table.querySelectorAll('tr'));
        const isNumericColumn = ['distance', 'snr'].includes(headers[columnIndex]);

        const currentOrder = sortOrder[columnIndex];
        sortOrder[columnIndex] = currentOrder === 'asc' ? 'desc' : 'asc';

        rows.sort((a, b) => {
            const aText = a.children[columnIndex].textContent.trim();
            const bText = b.children[columnIndex].textContent.trim();

            if (isNumericColumn) {
                return sortOrder[columnIndex] === 'asc' ? parseFloat(aText) - parseFloat(bText) : parseFloat(bText) - parseFloat(aText);
            } else {
                return sortOrder[columnIndex] === 'asc' ? aText.localeCompare(bText) : bText.localeCompare(aText);
            }
        });

        while (table.firstChild) {
            table.removeChild(table.firstChild);
        }

        rows.forEach(row => table.appendChild(row));
    }

    function showNoRecordsAlert() {
        var alertElement = document.createElement('div');
        alertElement.classList.add('alert', 'alert-danger', 'alert-dismissible', 'fade', 'show');
        alertElement.setAttribute('role', 'alert');

        alertElement.innerHTML = `
        No records for this band.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

        var alertPlaceholder = document.getElementById('alertPlaceholder');
        alertPlaceholder.appendChild(alertElement);

        setTimeout(function () {
            alertElement.remove();
        }, 1000);
    }

</script>
</body>
</html>
